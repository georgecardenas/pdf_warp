<?php
/** HOOK VIEWS_API **/
function pdf_warp_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'pdf_warp') . '/includes/views',
    'template path' => drupal_get_path('module', 'pdf_warp') . '/themes',
  );
}

/** HOOK DEFAULT VIEWS **/
function pdf_warp_views_default_views() {
  $view = new view();
  $view->name = 'uc_catalog_json';
  $view->description = 'Catalog';
  $view->tag = '';
  $view->base_table = 'node';
  $view->human_name = 'uc_catalog_json';
  $view->core = 0;
  $view->api_version = '3.0';
  $view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */

  /* Display: Defaults */
  $handler = $view->new_display('default', 'Defaults', 'default');
  $handler->display->display_options['title'] = 'Catalog';
  $handler->display->display_options['use_more_always'] = FALSE;
  $handler->display->display_options['access']['type'] = 'none';
  $handler->display->display_options['cache']['type'] = 'none';
  $handler->display->display_options['query']['type'] = 'views_query';
  $handler->display->display_options['exposed_form']['type'] = 'basic';
  $handler->display->display_options['pager']['type'] = 'full';
  $handler->display->display_options['style_plugin'] = 'views_json';
  $handler->display->display_options['style_options']['root_object'] = 'products';
  $handler->display->display_options['style_options']['top_child_object'] = 'product';
  $handler->display->display_options['style_options']['plaintext_output'] = 1;
  $handler->display->display_options['style_options']['remove_newlines'] = 0;
  $handler->display->display_options['style_options']['jsonp_prefix'] = '';
  $handler->display->display_options['style_options']['using_views_api_mode'] = 0;
  $handler->display->display_options['style_options']['object_arrays'] = 0;
  $handler->display->display_options['style_options']['numeric_strings'] = 0;
  $handler->display->display_options['style_options']['bigint_string'] = 0;
  $handler->display->display_options['style_options']['pretty_print'] = 0;
  $handler->display->display_options['style_options']['unescaped_slashes'] = 0;
  $handler->display->display_options['style_options']['unescaped_unicode'] = 0;
  $handler->display->display_options['style_options']['char_encoding'] = array();
  /* Field: Content: Image */
  $handler->display->display_options['fields']['entity_id']['id'] = 'entity_id';
  $handler->display->display_options['fields']['entity_id']['table'] = 'field_data_uc_product_image';
  $handler->display->display_options['fields']['entity_id']['field'] = 'uc_product_image';
  $handler->display->display_options['fields']['entity_id']['label'] = '';
  $handler->display->display_options['fields']['entity_id']['hide_empty'] = TRUE;
  $handler->display->display_options['fields']['entity_id']['settings'] = array(
    'image_style' => 'uc_product_list',
    'image_link' => 'content',
  );
  $handler->display->display_options['fields']['entity_id']['delta_limit'] = '1';
  /* Field: Product: SKU */
  $handler->display->display_options['fields']['model']['id'] = 'model';
  $handler->display->display_options['fields']['model']['table'] = 'uc_products';
  $handler->display->display_options['fields']['model']['field'] = 'model';
  /* Field: Content: Title */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'node';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  /* Field: Content: Has new content */
  $handler->display->display_options['fields']['timestamp']['id'] = 'timestamp';
  $handler->display->display_options['fields']['timestamp']['table'] = 'history';
  $handler->display->display_options['fields']['timestamp']['field'] = 'timestamp';
  /* Field: Product: Display price */
  $handler->display->display_options['fields']['display_price']['id'] = 'display_price';
  $handler->display->display_options['fields']['display_price']['table'] = 'uc_products';
  $handler->display->display_options['fields']['display_price']['field'] = 'display_price';
  /* Field: Product: Buy it now button */
  $handler->display->display_options['fields']['buyitnowbutton']['id'] = 'buyitnowbutton';
  $handler->display->display_options['fields']['buyitnowbutton']['table'] = 'uc_products';
  $handler->display->display_options['fields']['buyitnowbutton']['field'] = 'buyitnowbutton';
  $handler->display->display_options['fields']['buyitnowbutton']['label'] = '';
  /* Contextual filter: Content: Has taxonomy term ID (with depth) */
  $handler->display->display_options['arguments']['term_node_tid_depth']['id'] = 'term_node_tid_depth';
  $handler->display->display_options['arguments']['term_node_tid_depth']['table'] = 'node';
  $handler->display->display_options['arguments']['term_node_tid_depth']['field'] = 'term_node_tid_depth';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_action'] = 'empty';
  $handler->display->display_options['arguments']['term_node_tid_depth']['title_enable'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['title'] = '%1';
  $handler->display->display_options['arguments']['term_node_tid_depth']['breadcrumb_enable'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['breadcrumb'] = 'Catalog';
  $handler->display->display_options['arguments']['term_node_tid_depth']['default_argument_type'] = 'taxonomy_tid';
  $handler->display->display_options['arguments']['term_node_tid_depth']['summary']['format'] = 'default_summary';
  $handler->display->display_options['arguments']['term_node_tid_depth']['specify_validation'] = TRUE;
  $handler->display->display_options['arguments']['term_node_tid_depth']['validate']['type'] = 'taxonomy_term';
  $handler->display->display_options['arguments']['term_node_tid_depth']['validate_options']['vocabularies'] = array(
    'catalog' => 'catalog',
  );
  $handler->display->display_options['arguments']['term_node_tid_depth']['validate']['fail'] = 'empty';
  $handler->display->display_options['arguments']['term_node_tid_depth']['depth'] = '0';
  $handler->display->display_options['arguments']['term_node_tid_depth']['set_breadcrumb'] = TRUE;
  /* Filter criterion: Content: Published */
  $handler->display->display_options['filters']['status']['id'] = 'status';
  $handler->display->display_options['filters']['status']['table'] = 'node';
  $handler->display->display_options['filters']['status']['field'] = 'status';
  $handler->display->display_options['filters']['status']['value'] = '1';
  /* Filter criterion: Node: Is a product */
  $handler->display->display_options['filters']['is_product']['id'] = 'is_product';
  $handler->display->display_options['filters']['is_product']['table'] = 'uc_products';
  $handler->display->display_options['filters']['is_product']['field'] = 'is_product';
  $handler->display->display_options['filters']['is_product']['value'] = '1';

  /* Display: Table */
  $handler = $view->new_display('page', 'Table', 'catalog');
  $handler->display->display_options['path'] = 'store/catalog/%/json';

  /* Display: Grid */
  $handler = $view->new_display('page', 'Grid', 'catalog_grid');
  $handler->display->display_options['defaults']['css_class'] = FALSE;
  $handler->display->display_options['css_class'] = 'uc-catalog';
  $handler->display->display_options['defaults']['style_plugin'] = FALSE;
  $handler->display->display_options['style_plugin'] = 'grid';
  $handler->display->display_options['style_options']['columns'] = '3';
  $handler->display->display_options['defaults']['style_options'] = FALSE;
  $handler->display->display_options['defaults']['row_plugin'] = FALSE;
  $handler->display->display_options['row_plugin'] = 'fields';
  $handler->display->display_options['defaults']['row_options'] = FALSE;
  $handler->display->display_options['defaults']['fields'] = FALSE;
  /* Field: Content: Title */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'node';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  $handler->display->display_options['fields']['title']['label'] = '';
  /* Field: Product: SKU */
  $handler->display->display_options['fields']['model']['id'] = 'model';
  $handler->display->display_options['fields']['model']['table'] = 'uc_products';
  $handler->display->display_options['fields']['model']['field'] = 'model';
  $handler->display->display_options['fields']['model']['label'] = '';
  /* Field: Content: Image */
  $handler->display->display_options['fields']['entity_id']['id'] = 'entity_id';
  $handler->display->display_options['fields']['entity_id']['table'] = 'field_data_uc_product_image';
  $handler->display->display_options['fields']['entity_id']['field'] = 'uc_product_image';
  $handler->display->display_options['fields']['entity_id']['label'] = '';
  $handler->display->display_options['fields']['entity_id']['hide_empty'] = TRUE;
  $handler->display->display_options['fields']['entity_id']['settings'] = array(
    'image_style' => 'uc_product_list',
    'image_link' => 'content',
  );
  $handler->display->display_options['fields']['entity_id']['delta_limit'] = '1';
  /* Field: Product: Display price */
  $handler->display->display_options['fields']['display_price']['id'] = 'display_price';
  $handler->display->display_options['fields']['display_price']['table'] = 'uc_products';
  $handler->display->display_options['fields']['display_price']['field'] = 'display_price';
  $handler->display->display_options['fields']['display_price']['label'] = '';
  /* Field: Product: Buy it now button */
  $handler->display->display_options['fields']['buyitnowbutton']['id'] = 'buyitnowbutton';
  $handler->display->display_options['fields']['buyitnowbutton']['table'] = 'uc_products';
  $handler->display->display_options['fields']['buyitnowbutton']['field'] = 'buyitnowbutton';
  $handler->display->display_options['fields']['buyitnowbutton']['label'] = '';
  $handler->display->display_options['path'] = '_catalog_grid';
  
  $views[$view->name] = $view;

  $view = new view();
  $view->name = 'uc_products_json';
  $view->description = '';
  $view->tag = 'Ubercart';
  $view->base_table = 'node';
  $view->human_name = 'uc_product_json';
  $view->core = 0;
  $view->api_version = '3.0';
  $view->disabled = FALSE; /* Edit this to true to make a default view disabled initially */

  /* Display: Defaults */
  $handler = $view->new_display('default', 'Defaults', 'default');
  $handler->display->display_options['title'] = 'Product JSON';
  $handler->display->display_options['use_more_always'] = FALSE;
  $handler->display->display_options['access']['type'] = 'none';
  $handler->display->display_options['cache']['type'] = 'none';
  $handler->display->display_options['query']['type'] = 'views_query';
  $handler->display->display_options['query']['options']['query_comment'] = FALSE;
  $handler->display->display_options['exposed_form']['type'] = 'basic';
  $handler->display->display_options['pager']['type'] = 'full';
  $handler->display->display_options['pager']['options']['items_per_page'] = '50';
  $handler->display->display_options['pager']['options']['offset'] = '0';
  $handler->display->display_options['pager']['options']['id'] = '0';
  $handler->display->display_options['style_plugin'] = 'views_json';
  $handler->display->display_options['style_options']['root_object'] = 'products';
  $handler->display->display_options['style_options']['top_child_object'] = 'product';
  $handler->display->display_options['style_options']['plaintext_output'] = 1;
  $handler->display->display_options['style_options']['remove_newlines'] = 0;
  $handler->display->display_options['style_options']['jsonp_prefix'] = '';
  $handler->display->display_options['style_options']['using_views_api_mode'] = 0;
  $handler->display->display_options['style_options']['object_arrays'] = 0;
  $handler->display->display_options['style_options']['numeric_strings'] = 0;
  $handler->display->display_options['style_options']['bigint_string'] = 0;
  $handler->display->display_options['style_options']['pretty_print'] = 0;
  $handler->display->display_options['style_options']['unescaped_slashes'] = 0;
  $handler->display->display_options['style_options']['unescaped_unicode'] = 0;
  $handler->display->display_options['style_options']['char_encoding'] = array();
  /* Field: Content: Image */
  $handler->display->display_options['fields']['uc_product_image']['id'] = 'uc_product_image';
  $handler->display->display_options['fields']['uc_product_image']['table'] = 'field_data_uc_product_image';
  $handler->display->display_options['fields']['uc_product_image']['field'] = 'uc_product_image';
  $handler->display->display_options['fields']['uc_product_image']['hide_alter_empty'] = FALSE;
  $handler->display->display_options['fields']['uc_product_image']['click_sort_column'] = 'fid';
  $handler->display->display_options['fields']['uc_product_image']['settings'] = array(
    'image_style' => 'medium',
    'image_link' => 'content',
  );
  $handler->display->display_options['fields']['uc_product_image']['delta_limit'] = '1';
  $handler->display->display_options['fields']['uc_product_image']['delta_offset'] = '0';
  /* Field: Content: Title */
  $handler->display->display_options['fields']['title']['id'] = 'title';
  $handler->display->display_options['fields']['title']['table'] = 'node';
  $handler->display->display_options['fields']['title']['field'] = 'title';
  /* Field: Product: Display price */
  $handler->display->display_options['fields']['display_price']['id'] = 'display_price';
  $handler->display->display_options['fields']['display_price']['table'] = 'uc_products';
  $handler->display->display_options['fields']['display_price']['field'] = 'display_price';
  /* Field: Content: Updated date */
  $handler->display->display_options['fields']['changed']['id'] = 'changed';
  $handler->display->display_options['fields']['changed']['table'] = 'node';
  $handler->display->display_options['fields']['changed']['field'] = 'changed';
  $handler->display->display_options['fields']['changed']['label'] = 'Updated';
  $handler->display->display_options['fields']['changed']['hide_alter_empty'] = FALSE;
  $handler->display->display_options['fields']['changed']['date_format'] = 'uc_store';
  /* Field: Content: Body */
  $handler->display->display_options['fields']['body']['id'] = 'body';
  $handler->display->display_options['fields']['body']['table'] = 'field_data_body';
  $handler->display->display_options['fields']['body']['field'] = 'body';
  $handler->display->display_options['fields']['body']['label'] = 'Description';
  /* Field: Product: Height */
  $handler->display->display_options['fields']['height']['id'] = 'height';
  $handler->display->display_options['fields']['height']['table'] = 'uc_products';
  $handler->display->display_options['fields']['height']['field'] = 'height';
  $handler->display->display_options['fields']['height']['precision'] = '0';
  /* Field: Product: Length */
  $handler->display->display_options['fields']['length']['id'] = 'length';
  $handler->display->display_options['fields']['length']['table'] = 'uc_products';
  $handler->display->display_options['fields']['length']['field'] = 'length';
  $handler->display->display_options['fields']['length']['precision'] = '0';
  /* Field: Product: SKU */
  $handler->display->display_options['fields']['model']['id'] = 'model';
  $handler->display->display_options['fields']['model']['table'] = 'uc_products';
  $handler->display->display_options['fields']['model']['field'] = 'model';
  /* Field: Product: Weight */
  $handler->display->display_options['fields']['weight']['id'] = 'weight';
  $handler->display->display_options['fields']['weight']['table'] = 'uc_products';
  $handler->display->display_options['fields']['weight']['field'] = 'weight';
  $handler->display->display_options['fields']['weight']['precision'] = '0';
  /* Field: Product: Width */
  $handler->display->display_options['fields']['width']['id'] = 'width';
  $handler->display->display_options['fields']['width']['table'] = 'uc_products';
  $handler->display->display_options['fields']['width']['field'] = 'width';
  $handler->display->display_options['fields']['width']['precision'] = '0';
  /* Contextual filter: Content: Nid */
  $handler->display->display_options['arguments']['nid']['id'] = 'nid';
  $handler->display->display_options['arguments']['nid']['table'] = 'node';
  $handler->display->display_options['arguments']['nid']['field'] = 'nid';
  $handler->display->display_options['arguments']['nid']['default_action'] = 'default';
  $handler->display->display_options['arguments']['nid']['default_argument_type'] = 'fixed';
  $handler->display->display_options['arguments']['nid']['default_argument_options']['argument'] = 'null';
  $handler->display->display_options['arguments']['nid']['summary']['number_of_records'] = '0';
  $handler->display->display_options['arguments']['nid']['summary']['format'] = 'default_summary';
  $handler->display->display_options['arguments']['nid']['summary_options']['items_per_page'] = '25';
  /* Filter criterion: Content: Published */
  $handler->display->display_options['filters']['status']['id'] = 'status';
  $handler->display->display_options['filters']['status']['table'] = 'node';
  $handler->display->display_options['filters']['status']['field'] = 'status';
  $handler->display->display_options['filters']['status']['value'] = 1;
  $handler->display->display_options['filters']['status']['expose']['operator'] = FALSE;
  /* Filter criterion: Node: Is a product */
  $handler->display->display_options['filters']['is_product']['id'] = 'is_product';
  $handler->display->display_options['filters']['is_product']['table'] = 'uc_products';
  $handler->display->display_options['filters']['is_product']['field'] = 'is_product';
  $handler->display->display_options['filters']['is_product']['value'] = 1;
  $handler->display->display_options['filters']['is_product']['expose']['operator'] = FALSE;
  /* Filter criterion: Content: Title */
  $handler->display->display_options['filters']['title']['id'] = 'title';
  $handler->display->display_options['filters']['title']['table'] = 'node';
  $handler->display->display_options['filters']['title']['field'] = 'title';
  $handler->display->display_options['filters']['title']['operator'] = 'contains';
  $handler->display->display_options['filters']['title']['exposed'] = TRUE;
  $handler->display->display_options['filters']['title']['expose']['operator_id'] = 'title_op';
  $handler->display->display_options['filters']['title']['expose']['label'] = 'Title';
  $handler->display->display_options['filters']['title']['expose']['operator'] = 'title_op';
  $handler->display->display_options['filters']['title']['expose']['identifier'] = 'title';

  /* Display: Product JSON */
  $handler = $view->new_display('page', 'Product JSON', 'admin_page');
  $handler->display->display_options['path'] = 'store/product/%/json';
  $handler->display->display_options['menu']['title'] = 'View products';
  $handler->display->display_options['menu']['description'] = 'View and search products available through your website.';
  $handler->display->display_options['menu']['weight'] = '-10';
  $handler->display->display_options['menu']['name'] = 'management';
  $handler->display->display_options['menu']['context'] = 0;
  $handler->display->display_options['menu']['context_only_inline'] = 0;
  
  $views[$view->name] = $view;

  return $views;
}

/** HOOK FORM_ALTER **/
function pdf_warp_form_alter(&$form, $form_state, $form_id) {
  if (strpos($form_id, 'uc_product_add_to_cart_form') !== false) {
    $form['to_pdf_button'] = array(
      '#type' => 'submit',
      '#value' => t('Generar PDF'),
      '#submit' => array('pdf_warp_goto_generation')
    );
  }
}

/** HOOK PAGE ALTER **/
function pdf_warp_page_alter(&$page){
  if (strpos($page['content']['system_main']['products']['#markup'], 'view-uc-catalog') != false){
    $url = explode("/", current_path());
    $page['content']['system_main']['products']['#markup'] = $page['content']['system_main']['products']['#markup'].'<a href="'.$GLOBALS['base_url'].'/pdf_warp/generate/catalog/'.$url[1].'" style="appearance: button;-moz-appearance: button;-webkit-appearance: button;text-decoration: none; font: menu; color: ButtonText;display: inline-block; padding: 2px 8px;">Generar PDF</a>';
  }
}

/** HOOK MENU **/
function pdf_warp_menu() {
  $items['pdf_warp/generate/product/%'] = array(
    'title'            => 'PDF Warp generación',
    'description'      => 'Generación de PDF',
    'page callback'    => 'pdf_warp_generate_product_page',
    'page arguments'   => array(3),
    'access arguments' => array('access content'),
  );
  
  $items['pdf_warp/generate/catalog/%'] = array(
    'title'            => 'PDF Warp generación',
    'description'      => 'Generación de PDF',
    'page callback'    => 'pdf_warp_generate_catalog_page',
    'page arguments'   => array(3),
    'access arguments' => array('access content'),
  );
  
  $items['admin/appearance/pdf_warp'] = array(
    'title'            => 'PDF Warp',
    'description'      => 'Configuración de plantillas',
    'page callback'    => 'pdf_warp_admin_page',
    'access arguments' => array('administer site configuration'),
    'type'             => MENU_LOCAL_TASK,
  );
  
  $items['admin/appearance/pdf_warp/delete/%'] = array(
    'title' => t('Borrar plantilla'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pdf_warp_template_delete_confirm', 4),
    'access arguments' => array('administer site configuration'),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK, 
  );
  
  $items['admin/appearance/pdf_warp/enable/%'] = array(
    'title' => t('Activar plantilla'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pdf_warp_template_enable_confirm', 4),
    'access arguments' => array('administer site configuration'),
    'access callback' => TRUE,
    'type' => MENU_CALLBACK, 
  );
  
  $items['admin/appearance/pdf_warp/add'] = array(
    'title' => t('Nueva plantilla'),
    'page callback' => 'drupal_get_form',
    'page arguments' => array('pdf_warp_form_add_template'),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_LOCAL_ACTION,
  );
  
  $items['admin/appearance/pdf_warp/edit/%'] = array(
    'title' => t('Editar plantilla'),
    'page callback' => 'pdf_warp_edit_template_page',
    'page arguments' => array(4),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );
  
  $items['admin/appearance/pdf_warp/edit/%/save'] = array(
    'title' => t('Guardar plantilla'),
    'page callback' => 'pdf_warp_save_edit',
    'page arguments' => array(4),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK, 
  );
  
  $items['admin/appearance/pdf_warp/edit/catalog/%'] = array(
    'title' => t('Editar plantilla de catálogo'),
    'page callback' => 'pdf_warp_edit_catalog_template_page',
    'page arguments' => array(5),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK,
  );
  
  $items['admin/appearance/pdf_warp/edit/catalog/%/save'] = array(
    'title' => t('Guardar plantilla'),
    'page callback' => 'pdf_warp_catalog_save_edit',
    'page arguments' => array(5),
    'access arguments' => array('administer site configuration'),
    'type' => MENU_CALLBACK, 
  );

  return $items;
}

/**** MAIN PAGE ****/
function pdf_warp_admin_page() {
  $header = array('ID', 'Nombre', 'Tipo', 'Operaciones','ACTIVO');

  $sql = "SELECT * FROM {pdf_warp_templates}";
  $result = db_query($sql);
  
  $rows = array();

  foreach ($result as $v) {
    $rows[] = array(
      $v->id,
      $v->name,
      $v->type == 'product' ? 'Producto' : 'Catálogo',
      ($v->type == 'product' ? "<a href='pdf_warp/edit/{$v->id}'>" : "<a href='pdf_warp/edit/catalog/{$v->id}'>") . t('Editar') . "</a> | <a href='pdf_warp/delete/{$v->id}'>" . t('Borrar') . "</a> | <a href='pdf_warp/enable/{$v->id}'>" . t('Activar') . "</a>",
      $v->active == 1 ? 'SI' : '',
    );
  }
  
  return theme('table', array('header' => $header, 'rows' => $rows)).theme('pager');
}

function pdf_warp_theme(){
  return array(
    'pdf_warp_template' => array (
      'template' => 'pdf-warp-template'
    ),
    'pdf_warp_generation' => array (
      'template' => 'pdf-warp-generation'
    )
    ,
    'pdf_warp_catalog_template' => array (
      'template' => 'pdf-warp-catalog-template'
    )
    ,
    'pdf_warp_catalog_generation' => array (
      'template' => 'pdf-warp-catalog-generation'
    )
  );
}

/**** GENERATE PRODUCT PDF PAGE ****/
function pdf_warp_generate_product_page($id_item) {
  drupal_add_library('angularjs', 'angularjs');
  
  $path = drupal_get_path('module', 'pdf_warp');
  drupal_add_css($path.'/css/pdf_warp_template.css');
  drupal_add_js($path.'/js/pdf_warp_generation.js');
  drupal_add_js($path.'/js/vendor/jspdf.min.js');
  drupal_add_js($path.'/js/vendor/html2pdf.js');
  drupal_add_js($path.'/js/vendor/bower_components/classie/classie.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventEmitter/EventEmitter.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventie/eventie.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-style-property/get-style-property.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-size/get-size.js');
  drupal_add_js($path.'/js/vendor/bower_components/draggabilly/draggabilly.js');
  drupal_add_js($path.'/js/vendor/bower_components/angular-draggabilly/dist/angular-draggabilly.js');
  
  $sql = "SELECT * FROM {pdf_warp_templates} WHERE active=1 AND type='product'";
  $settings['pdf_warp']['template_content'] = db_query($sql)->fetchAll();
  $settings['pdf_warp']['base_url'] = $GLOBALS['base_url'];
  drupal_add_js($settings, 'setting');
  
  return theme('pdf_warp_generation');
}

function pdf_warp_generate_catalog_page($id_item) {
  drupal_add_library('angularjs', 'angularjs');
  
  $path = drupal_get_path('module', 'pdf_warp');
  drupal_add_css($path.'/css/pdf_warp_template.css');
  drupal_add_js($path.'/js/pdf_warp_catalog_generation.js');
  drupal_add_js($path.'/js/vendor/jspdf.min.js');
  drupal_add_js($path.'/js/vendor/html2pdf.js');
  drupal_add_js($path.'/js/vendor/bower_components/classie/classie.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventEmitter/EventEmitter.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventie/eventie.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-style-property/get-style-property.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-size/get-size.js');
  drupal_add_js($path.'/js/vendor/bower_components/draggabilly/draggabilly.js');
  drupal_add_js($path.'/js/vendor/bower_components/angular-draggabilly/dist/angular-draggabilly.js');
  
  $sql = "SELECT * FROM {pdf_warp_templates} WHERE active=1 AND type='catalog'";
  $settings['pdf_warp']['template_content'] = db_query($sql)->fetchAll();
  $settings['pdf_warp']['base_url'] = $GLOBALS['base_url'];
  drupal_add_js($settings, 'setting');
  
  return theme('pdf_warp_catalog_generation');
}

/**** FUNCTIONS TO EDIT TEMPLATE ****/
function pdf_warp_edit_template_page($id_template) {
  drupal_add_library('angularjs', 'angularjs');
  
  $path = drupal_get_path('module', 'pdf_warp');
  drupal_add_css($path.'/css/pdf_warp_template.css');
  drupal_add_js($path.'/js/pdf_warp.js');
  drupal_add_js($path.'/js/vendor/jspdf.min.js');
  drupal_add_js($path.'/js/vendor/html2pdf.js');
  drupal_add_js($path.'/js/vendor/bower_components/classie/classie.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventEmitter/EventEmitter.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventie/eventie.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-style-property/get-style-property.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-size/get-size.js');
  drupal_add_js($path.'/js/vendor/bower_components/draggabilly/draggabilly.js');
  drupal_add_js($path.'/js/vendor/bower_components/angular-draggabilly/dist/angular-draggabilly.js');
  
  $sql = "SELECT * FROM {pdf_warp_templates} WHERE id=".$id_template;
  $settings['pdf_warp']['template_content'] = db_query($sql)->fetchAll();
  $sql = "SELECT nid FROM {uc_products}";
  $settings['pdf_warp']['products'] = db_query($sql)->fetchAll();
  $settings['pdf_warp']['base_url'] = $GLOBALS['base_url'];
  drupal_add_js($settings, 'setting');
  
  return theme('pdf_warp_template');
}

function pdf_warp_save_edit($id_template) {
  $data = file_get_contents("php://input",  TRUE);
  $decoded_data = urldecode($data);
  
  $result = db_update('pdf_warp_templates')
  ->fields(array(
    'content' => substr($decoded_data, strpos($decoded_data, "content=") + 8, strpos($decoded_data, "&") - 8)
  ))
  ->condition('id', $id_template, '=')
  ->execute();
  
  drupal_set_message(t('La plantilla ha sido guardada con éxito.'));
  drupal_goto("admin/appearance/pdf_warp");
}


function pdf_warp_edit_catalog_template_page($id_template) {
  drupal_add_library('angularjs', 'angularjs');
  
  $path = drupal_get_path('module', 'pdf_warp');
  drupal_add_css($path.'/css/pdf_warp_template.css');
  drupal_add_js($path.'/js/pdf_warp_catalog.js');
  drupal_add_js($path.'/js/vendor/jspdf.min.js');
  drupal_add_js($path.'/js/vendor/html2pdf.js');
  drupal_add_js($path.'/js/vendor/bower_components/classie/classie.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventEmitter/EventEmitter.js');
  drupal_add_js($path.'/js/vendor/bower_components/eventie/eventie.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-style-property/get-style-property.js');
  drupal_add_js($path.'/js/vendor/bower_components/get-size/get-size.js');
  drupal_add_js($path.'/js/vendor/bower_components/draggabilly/draggabilly.js');
  drupal_add_js($path.'/js/vendor/bower_components/angular-draggabilly/dist/angular-draggabilly.js');
  
  $sql = "SELECT * FROM {pdf_warp_templates} WHERE id=".$id_template;
  $settings['pdf_warp']['template_content'] = db_query($sql)->fetchAll();
  drupal_add_js($settings, 'setting');
  
  return theme('pdf_warp_catalog_template');
}

function pdf_warp_catalog_save_edit($id_template) {
  $data = file_get_contents("php://input",  TRUE);
  $decoded_data = urldecode($data);
  
  $result = db_update('pdf_warp_templates')
  ->fields(array(
    'content' => substr($decoded_data, strpos($decoded_data, "content=") + 8, strpos($decoded_data, "&") - 8)
  ))
  ->condition('id', $id_template, '=')
  ->execute();
  
  drupal_set_message(t('La plantilla ha sido guardada con éxito.'));
  drupal_goto("admin/appearance/pdf_warp");
}

/**** FUNCTIONS TO ADD TEMPLATE ****/
function pdf_warp_form_add_template() {
  $form = array();

  $form['template_name'] = array(
    '#type' => 'textfield',
    '#title' => t('Nombre'),
    '#maxlength' => 255,
    '#description' => t("El nombre de la plantilla."),
    '#required' => TRUE,
  );
  
  $form['template_type'] = array(
    '#type' => 'radios',
    '#title' => t('Tipo'),
    '#description' => t('El tipo de la plantilla.'),
    '#options' => array(
      t('Producto'),
      t('Catálogo'),
    ),
    '#required' => TRUE,
  );
  
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => 'Guardar',
  );
  
  return $form;
}

function pdf_warp_form_add_template_submit(&$form, $form_state) {
  $result = db_insert('pdf_warp_templates')
  ->fields(array(
    'name' => $form_state['values']['template_name'],
    'type' => $form_state['values']['template_type'] == 0 ? 'product' : 'catalog',
    'content' => $form_state['values']['template_type'] == 0 ? '{"pdf_elements":{"pdf_product_title":{"x":23,"y":27,"width":495,"height":25,"fontSize":"22px"},"pdf_product_image":{"x":546.109375,"y":23,"width":220,"height":226,"fontSize":"12px"},"pdf_product_description":{"x":23,"y":64,"width":495,"height":180,"fontSize":"12px"},"pdf_product_price":{"x":558.109375,"y":253,"width":200,"height":20,"fontSize":"18px"},"pdf_product_sku":{"x":1343.21875,"y":150,"width":83.328125,"height":20,"fontSize":"12px"},"pdf_product_length":{"x":31,"y":284,"width":120,"height":20,"fontSize":"12px"},"pdf_product_width":{"x":31.109375,"y":259,"width":120,"height":20,"fontSize":"12px"},"pdf_product_height":{"x":31.21875,"y":310,"width":120,"height":20,"fontSize":"12px"},"pdf_product_weight":{"x":239.328125,"y":260,"width":120,"height":20,"fontSize":"12px"}},"edit_elements":{"pdf_product_title":{"left":"23px","top":"-176px","width":"495px","height":"25px","fontSize":"22px"},"pdf_product_image":{"left":"47px","top":"23px","width":null,"height":null,"fontSize":"12px"},"pdf_product_description":{"left":"23px","top":"-166px","width":"495px","height":"180px","fontSize":"12px"},"pdf_product_price":{"left":"59px","top":"25px","width":"200px","height":"20px","fontSize":"18px"},"pdf_product_sku":{"left":"640px","top":"-80px","width":null,"height":null,"fontSize":"12px"},"pdf_product_length":{"left":"31px","top":"-126px","width":"120px","height":"20px","fontSize":"12px"},"pdf_product_width":{"left":"-93px","top":"-151px","width":"120px","height":"20px","fontSize":"12px"},"pdf_product_height":{"left":"-217px","top":"-100px","width":"120px","height":"20px","fontSize":"12px"},"pdf_product_weight":{"left":"-133px","top":"-150px","width":"120px","height":"20px","fontSize":"12px"}}}' : '{"pdf_elements":{"pdf_product_0":{"x":30,"y":30,"width":350,"height":350},"pdf_product_1":{"x":420,"y":30,"width":350,"height":350},"pdf_product_2":{"x":30,"y":386,"width":350,"height":350},"pdf_product_3":{"x":420,"y":386,"width":350,"height":350},"pdf_product_4":{"x":30,"y":742,"width":350,"height":350},"pdf_product_5":{"x":420,"y":742,"width":350,"height":350}},"edit_elements":{"pdf_product_0":{"left":"30px","top":"30px","width":null,"height":null},"pdf_product_1":{"left":"70px","top":"30px","width":null,"height":null},"pdf_product_2":{"left":"30px","top":"30px","width":null,"height":null},"pdf_product_3":{"left":"70px","top":"30px","width":null,"height":null},"pdf_product_4":{"left":"30px","top":"30px","width":null,"height":null},"pdf_product_5":{"left":"70px","top":"30px","width":null,"height":null}},"renderMode":"text","itemsPerPage":"6"}',
  ))
  ->execute();
  drupal_set_message(t('La plantilla ' .$result.' ha sido creada con éxito.'));
  if ($form_state['values']['template_type'] == 0){
    drupal_goto("admin/appearance/pdf_warp/edit/".$result);
  } else {
    drupal_goto("admin/appearance/pdf_warp/edit/catalog/".$result);
  }
}

/**** FUNCTIONS TO DELETE TEMPLATE ****/
function pdf_warp_template_delete_confirm($form ,&$form_state, $id_template) {
  $form['_template'] = array(
    '#type' => 'value',
    '#value' => $id_template,
  );
		
  return confirm_form($form,t('Borrar plantilla'),'admin/appearance/pdf_warp',
    t('<p>¿Deseas eliminar la plantilla '.$id_template.'?</p><p>Esta acción no se puede deshacer.</p>'),t('Borrar'),t('Cancelar'));
		
}
                      
function pdf_warp_template_delete_confirm_submit($form, &$form_state) {
  $form_values = $form_state['values'];
  if ($form_state['values']['confirm']) {
    $id_template = $form_state['values']['_template'];

    $result = db_query("DELETE FROM {pdf_warp_templates} where id='{$id_template}'");
    drupal_set_message(t('La plantilla ' .$id_template.' ha sido borrada con éxito.'));
  }
    drupal_goto("admin/appearance/pdf_warp");
}

/**** FUNCTIONS TO ACTIVE TEMPLATE ****/
function pdf_warp_template_enable_confirm($form ,&$form_state, $id_template) {
  $form['_template'] = array(
    '#type' => 'value',
    '#value' => $id_template,
  );
		
  return confirm_form($form,t('Activar plantilla'),'admin/appearance/pdf_warp',
    t('<p>¿Deseas establecer la plantilla '.$id_template.' como la plantilla activa?</p>'),t('Activar'),t('Cancelar'));
		
}
                      
function pdf_warp_template_enable_confirm_submit($form, &$form_state) {
  $form_values = $form_state['values'];
  if ($form_state['values']['confirm']) {
    $id_template = $form_state['values']['_template'];
    
    $sql = "SELECT * FROM {pdf_warp_templates} WHERE id=".$id_template;
    $templateResult = db_query($sql);
    $templateType = 'product';
    
    foreach ($templateResult as $v) {
      $templateType = $v->type;
    }

    $result = db_update('pdf_warp_templates')
    ->fields(array(
      'active' => 0
    ))
    ->condition('type', $templateType, '=')
    ->execute();
    
    $result = db_update('pdf_warp_templates')
    ->fields(array(
      'active' => 1
    ))
    ->condition('id', $id_template, '=')
    ->execute();
    drupal_set_message(t('La plantilla ' .$id_template.' ha sido activada con éxito.'));
  }
    drupal_goto("admin/appearance/pdf_warp");
}

function pdf_warp_goto_generation($form, $form_state) {
  $form_id_array = explode('_',$form['#form_id']);
  $product_id = end($form_id_array);
  drupal_goto('pdf_warp/generate/product/'.$product_id);
}